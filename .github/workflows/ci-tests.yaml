# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: Run CI tests

on:
  workflow_call:


jobs:
  checks:
    uses: ./.github/workflows/ci-checks.yaml

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    strategy:
      fail-fast: true
      matrix:
        python-version:
          - "3.10"
    needs:
      - checks
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - id: setup-python
        name: Setup Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: ${{matrix.python-version}}
          architecture: x64
      - name: Install tox & poetry
        run: |
          pipx install tox
          pipx install poetry
      - id: tests-unit
        name: Run Unittests
        run: |
          cd python && tox -e unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    strategy:
      max-parallel: 7
      fail-fast: false
      # matrix:
        # spark-version: ["3.4.2", "3.5.1"]
        # bundle-backend: ["yaml", "terraform"]
        # storage-backend: ["s3", "azure"]
        # cos-model: ["", "cos"]
        # tox-environments:
        #   - integration-sparkjob
        #   - integration-bundle
        #   - integration-kyuubi
        # juju:
        #   - snap_channel: "3.4/stable"
        #     agent: "3.4.2"
        #   - snap_channel: "3.6/stable"
        #     agent: "3.6.0"
        # exclude:
        #   # COS bundle is mandatory for sparkjob test.
        #   - tox-environments: integration-sparkjob # COS is mandatory for the sparkjob test
        #     cos-model:

        #   # COS bundle is mandatory for Kyuubi test.
        #   - tox-environments: integration-kyuubi
        #     cos-model:

        # include:
        #   - tox-environments: integration-basic


    needs:
      - checks
      - unit-tests
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Run individual integration test
        uses: ./.github/actions/run-test@minimize-tests
        with:
          tox-env: integration-basic